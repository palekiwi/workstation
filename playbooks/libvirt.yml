---
- name: Configure libvirt.
  hosts: workstation
  become: true

  handlers:
    - name: Import handlers
      ansible.builtin.import_tasks: ./handlers/main.yml

  tasks:
    - name: Ensure packages are installed.
      community.general.rpm_ostree_pkg:
        name:
          - virt-install
          - libvirt-daemon-config-network
          - libvirt-daemon-kvm
          - qemu-kvm
          - virt-manager
          - virt-viewer
        state: present
      notify: Require reboot.

    - name: Add polkit rule for user.
      ansible.builtin.copy:
        dest: "/etc/polkit-1/rules.d/80-libvirt-manage.rules"
        content: |
          polkit.addRule(function(action, subject) {
            if (action.id == "org.libvirt.unix.manage" && subject.local && subject.active && subject.isInGroup("wheel")) {
                return polkit.Result.YES;
            }
          });
        mode: "0644"
